<link rel="stylesheet" type="text/css" href="examples-style.css">
<div>
  <h1>IndexedDB Observers Demo App</h1>
  <p>This example allows the user to exeriment with the behavior of idb observers.</p>
</div>
<div id="os1-buttons" class="buttons">
Object Store 1 ('os1')<br/>
<input type="button" value="Clear" onclick="clearObjectStore('os1');"/> the objectStore.<br/>
<input type="button" value="Add" onclick="addElements('os1');"/> elements 1, 2, 3<br/>
<input type="button" value="Put" onclick="putElements('os1');"/> elements 2, 3, 4<br/>
<input type="button" value="Delete" onclick="deleteElements('os1');"/> elements 1, 2<br/>
<input type="button" value="All" onclick="mixed('os1');"/> All of the above in one transaction.
</div>
<div id="os2-buttons" class="buttons">
Object Store 2 ('os2')<br/>
<input type="button" value="Clear" onclick="clearObjectStore('os2');"/> the objectStore.<br/>
<input type="button" value="Add" onclick="addElements('os2');"/> elements 1, 2, 3<br/>
<input type="button" value="Put" onclick="putElements('os2');"/> elements 2, 3, 4<br/>
<input type="button" value="Delete" onclick="deleteElements('os2');"/> elements 1, 2<br/>
<input type="button" value="All" onclick="mixed('os2');"/> All of the above in one transaction.
</div>
<div style="clear: left;"></div>
<div id="observer-buttons" class="buttons">
Observers<br/> 
Object stores (comma separated): <input type="text" id="objectStoresInput"/><br/>
Key range (opt, inclusive, only first obj store) <input type="text" id="keyRangeInput"/><br/>
Include transaction <input type="checkbox" id="includeTransactionCheckbox"/><br/>
Include values <input type="checkbox" id="includeValuesCheckbox"/><br/>
<input type="button" value="Add" onclick="addObserver();"/><br/>
</div>
<div style="clear: left;"></div>
<div id="observers">
</div>
<div style="clear: left;"></div>
<div id="log-wrapper">
  <div><b>&nbsp;&nbsp;Page Log</b></div>
  <div id="js-log"> </div>
</div>
<script src="../polyfill.js"></script>
<script>
function log() {
  console.log.apply(console, arguments);
  var el = document.createElement('div');
  el.innerHTML = Array.prototype.join.call(
    Array.prototype.map.call(arguments, function(x, index) { return index == 0 ? '> ' + x : '&nbsp;&nbsp;' + x; }),
    '<br />');
  document.getElementById('js-log').appendChild(el);
}
var dbname = 'db' + Date.now();
var db;
log("Creating database connection.");
var req = indexedDB.open(dbname);
req.onupgradeneeded = function() {
  db = req.result;
  db.createObjectStore('os1');
  db.createObjectStore('os2');
};
req.onsuccess = function() {
  db = req.result;
  log("Database connection created to '" + dbname + "'.");
};

var observers = [];
var currentId = 0;
// id, lastChanges, lastMetadata, initialized, initializedState, ostores
function getDivForObserver(observer) {
  var out = '<div class="observer" id="observer' + observer.id + '"><h3>Observer \'' + observer.id + '\'</h3>'; 
  out += '<div class="content">'; 
  out += 'objectStores:<pre>' + JSON.stringify(observer.ostores, null, 2);
  out += '</pre>initialized: ' + observer.initialized;
  out += '<br/>initializedStates:<pre>' + JSON.stringify(observer.initializedState, null, 2);
  out += '</pre>lastChanges: <pre>' + JSON.stringify(observer.lastChanges, null, 2);
  out += '</pre>lastMetadata: <pre>' + JSON.stringify(sanitizeMetadata(observer.lastMetadata), null, 2);
  return out + '</pre></div></div>';
}

function updateObservers() {
  var observersDiv = document.getElementById('observers');
  observersDiv.innerHTML = '';
  for (var i = 0; i < observers.length; i++){
    observersDiv.innerHTML += getDivForObserver(observers[i]);
  }
}

// Makes it more readable
function sanitizeMetadata(metadata) {
  if (!metadata) {
    return metadata;
  }
  return {
    hasTransaction: !!metadata.transaction,
    db: metadata.db.name,
    objectStoreName: metadata.objectStoreName,
    isExternalChange: metadata.isExternalChange
  };
}

function addObserver() {
  var objectStores = document.getElementById('objectStoresInput').value.split(/[ ,]+/);
  if (objectStores.length === 1 && objectStores[0] === '') objectStores = [];
  var keyRange = document.getElementById('keyRangeInput').value.split(/[ ,]+/);
  if (keyRange.length === 1 && keyRange[0] === '') keyRange = [];
  var includeTransaction = document.getElementById('includeTransactionCheckbox').checked;
  var includeValues = document.getElementById('includeValuesCheckbox').checked;
  console.log(objectStores, keyRange, includeTransaction, includeValues);
  var observer = {};
  observer.ostores = objectStores;
  observer.id = currentId++;
  observer.initialized = false;
  observer.initializedState = {};
  keyRange = keyRange.map(function(element) {
    return parseInt(element, 10);
  });
  if (keyRange === [""] ) keyRange = [];
  if (objectStores.length === 0 || (keyRange.length != 0 && keyRange.length != 2) ||
      keyRange.indexOf(NaN) != -1) {
    log('invalid input: ', objectStores, keyRange);
    return;
  }
  if (keyRange.length == 2) {
    objectStores[0] = {
      name: objectStores[0],
      range: IDBKeyRange.bound(keyRange[0], keyRange[1], false, false)
    };
  }
  log('Creating observer ' + observer.id);
  observers.push(observer);
  var control = db.observe(objectStores, function(changes, metadata) {
    if (changes == null) {
      log('Initializing observer ' + observer.id);
      observer.initialized = true;
      for (var i = 0; i < objectStores.length; i++) {
        var accumulateContents = function(store) {
          store = typeof store === 'string' ? store : store.name;
          var contents = [];
          var request = metadata.transaction.objectStore(store).openCursor();
          request.onsuccess = function(event) {
            var cursor = event.target.result;
            if (cursor) {
              contents.push({ key: cursor.key, value: cursor.value });
              cursor.continue();
            } else {
              log('Done reading initial state.')
              observer.initializedState[store] = contents;
              updateObservers();
            }
          };
        };
        accumulateContents(objectStores[i]);
      }  
      observer.initialized = false;
    } else {
      observer.lastChanges = changes;
      observer.lastMetadata = metadata;
      log('Observer ' + observer.id + ' recieved changes and metadata: ',
          JSON.stringify(changes, null, 2),
          JSON.stringify(sanitizeMetadata(metadata)), null, 2);
      updateObservers();
    }
  }, { includeValues: includeValues, includeTransaction: includeTransaction });
};

function oncomplete() {
  log('Transaction oncomplete.');
}
function onerror(event) {
  log('Error in transaction:', event.target.error.message);
}

// button operations
function clearObjectStore(osname) {
  log('Clearing object store ' + osname);
  var txn = db.transaction(osname, 'readwrite');
  var store = txn.objectStore(osname);
  store.clear();
  txn.oncomplete = oncomplete;
  txn.onerror = log;
}

function addElements(osname) {
  log('Adding elements with keys 1, 2, 3');
  var txn = db.transaction(osname, 'readwrite');
  var store = txn.objectStore(osname);
  store.add('val1', 1);
  store.add('val2', 2);
  store.add('val3', 3);
  txn.oncomplete = oncomplete;
  txn.onerror = onerror;
}

function putElements(osname) {
  log('Putting elements with keys 2, 3, 4');
  var txn = db.transaction(osname, 'readwrite');
  var store = txn.objectStore(osname);
  store.put('putVal2', 2);
  store.put('putVal3', 3);
  store.put('putVal4', 4);
  txn.oncomplete = oncomplete;
  txn.onerror = onerror;
}

function deleteElements(osname) {
  log('Deleting elements with keys 1, 2');
  var txn = db.transaction(osname, 'readwrite');
  var store = txn.objectStore(osname);
  store.delete(IDBKeyRange.bound(1, 2, false, false));
  txn.oncomplete = oncomplete;
  txn.onerror = onerror;
}

function mixed(osname) {
  var txn = db.transaction(osname, 'readwrite');
  var store = txn.objectStore(osname);
  store.clear();
  store.add('val1', 1);
  store.add('val2', 2);
  store.add('val3', 3);
  store.put('putVal2', 2);
  store.put('putVal3', 3);
  store.put('putVal4', 4);
  store.delete(IDBKeyRange.bound(1, 2, false, false));
  txn.oncomplete = oncomplete;
  txn.onerror = onerror;
}

</script>
